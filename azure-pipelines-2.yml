trigger:
  - master

variables:
  DOCKER_USERNAME: shehan077
  DOCKER_PASSWORD: shehan@123
  IMAGE_NAME: ntb-app

# ----------------------------
# STAGE 1 → Build & Docker
# ----------------------------
stages:
- stage: BuildAndDocker
  displayName: "Build and Docker Push"
  jobs:
    - job: BuildAndDockerJob
      displayName: "Build using Hosted Agent"
      pool:
        vmImage: ubuntu-latest    # <-- FIXED
      steps:
        - task: Maven@3
          inputs:
            mavenPomFile: 'pom.xml'
            goals: 'package'

        - script: |
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
          displayName: "Docker Login"

        - script: |
            docker build -t $IMAGE_NAME:$(Build.BuildId) .
            docker tag $IMAGE_NAME:$(Build.BuildId) $IMAGE_NAME:latest
            docker tag $IMAGE_NAME:$(Build.BuildId) $DOCKER_USERNAME/$IMAGE_NAME:$(Build.BuildId)
            docker tag $IMAGE_NAME:latest $DOCKER_USERNAME/$IMAGE_NAME:latest
          displayName: "Docker Build & Tag"

        - script: |
            docker push $DOCKER_USERNAME/$IMAGE_NAME:$(Build.BuildId)
            docker push $DOCKER_USERNAME/$IMAGE_NAME:latest
          displayName: "Docker Push"

# ----------------------------
# STAGE 2 → Deploy
# ----------------------------
- stage: Deploy
  dependsOn: BuildAndDocker
  displayName: "Deploy to GKS"
  jobs:
    - deployment: DeployToKubernetes
      pool:
        name: gks-pool        
        demands:
          - agent.os -equals Linux

      environment:
        name: dev-gks
        resourceType: Kubernetes
        resourceName: Default

      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self

              - script: |
                  export KUBECONFIG=$HOME/.kube/config

                  sed -i "s|image:.*|image: $DOCKER_USERNAME/$IMAGE_NAME:$(Build.BuildId)|" k8s/deployment.yaml

                  kubectl apply -f k8s/deployment.yaml
                  kubectl apply -f k8s/service.yaml

                  kubectl rollout status deployment/ntb-app --timeout=300s
                displayName: "Apply K8s Deployment"

              - script: |
                  export KUBECONFIG=$HOME/.kube/config
                  kubectl get pods -l app=ntb-app -o wide
                  kubectl logs -l app=ntb-app --tail=20 --all-containers=true
                displayName: "Verify Deployment"
