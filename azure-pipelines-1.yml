trigger:
  - master

pool:
  name: Default
  demands:
    - agent.os -equals Linux

variables:
  - name: DOCKER_USERNAME
    value: shehan077
  - name: DOCKER_PASSWORD
    value: shehan@123

stages:
- stage: BuildAndDocker
  jobs:
    - job: BuildAndDockerJob
      workspace:
        clean: all
      steps:

        - task: Maven@3
          inputs:
            mavenPomFile: 'pom.xml'
            goals: 'package'

        - script: |
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
          displayName: "Docker Login"

        - script: |
            docker pull eclipse-temurin:17-jdk || true
          displayName: "Pre-pull JDK"

        - script: |
            cd $(Build.SourcesDirectory)
            docker build --network=host -t ntb-app:$(Build.BuildId) .
            docker tag ntb-app:$(Build.BuildId) ntb-app:latest
          displayName: "Docker Build"

- stage: Deploy
  dependsOn: BuildAndDocker
  jobs:
    - job: DeployToLocal
      steps:

        - checkout: self
        
        - script: |
            export KUBECONFIG=$HOME/.kube/config

            echo "Updating deployment image..."
            sed -i "s|image: ntb-app:.*|image: ntb-app:$(Build.BuildId)|" k8s/deployment.yaml

            kubectl apply -f k8s/deployment.yaml
            kubectl apply -f k8s/service.yaml

            kubectl rollout status deployment/ntb-app --timeout=300s
          displayName: "Deploy to Kubernetes"

        - script: |
            export KUBECONFIG=$HOME/.kube/config
            kubectl get pods -l app=ntb-app -o wide
            kubectl logs -l app=ntb-app --tail=20 --all-containers=true
          displayName: "Verify Deployment"


# trigger:
# - master

# pool:
#   name: Default
#   demands:
#     - agent.os -equals Linux

# variables:
#   DOCKER_USERNAME: shehan077
#   DOCKER_PASSWORD: shehan@123

# stages:
# - stage: BuildAndDocker
#   displayName: "Maven Build and Docker Image"
#   jobs:
#     - job: BuildAndDockerJob
#       workspace:
#         clean: outputs
#       steps:
#         # Maven Build
#         - task: Maven@3
#           inputs:
#             mavenPomFile: 'pom.xml'
#             mavenOptions: '-Xmx3072m'
#             javaHomeOption: 'Path'
#             jdkDirectory: '/usr/lib/jvm/java-17-openjdk-amd64'
#             goals: 'package'
#             publishJUnitResults: true
#             testResultsFiles: '**/surefire-reports/TEST-*.xml'
#           displayName: 'Maven Build'

#         # Docker Login
#         - script: |
#             echo $(DOCKER_PASSWORD) | docker login -u $(DOCKER_USERNAME) --password-stdin
#           displayName: "Docker Login"

#         # Pre-pull base image
#         - script: |
#             docker pull eclipse-temurin:17-jdk || echo "Already pulled or network issue"
#           displayName: "Pre-pull base image"

#         # Build Docker Image
#         - script: |
#             cd $(Build.SourcesDirectory)
#             docker build --network=host -t ntb-app:$(Build.BuildId) .
#           displayName: "Build Docker Image"

# - stage: Deploy
#   displayName: "Deploy to Local Kubernetes"
#   dependsOn: BuildAndDocker
#   jobs:
#     - deployment: DeployToLocal
#       environment: dev
#       strategy:
#         runOnce:
#           deploy:
#             steps:
#               - script: |
#                   echo "Deploying to local Kubernetes..."
#                   export KUBECONFIG=$HOME/.kube/config

#                   # If using Kind, load image into cluster
#                   # kind load docker-image ntb-app:$(Build.BuildId)

#                   kubectl apply -f k8s/deployment.yaml
#                   kubectl apply -f k8s/service.yaml
#                 displayName: "Deploy to Kubernetes"